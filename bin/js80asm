#!/usr/bin/env node
'use strict';

var Z80 = require('../z80')
  , program = require('commander')
  , _ = require('underscore');

function list(val) {
    return val.split(':');
}

program
  .version('0.0.1')
  .usage('[options] <file ...>')
  .option('-o, --output <file>', 'create binary compiled file (default a.out)')
  .option('-I, --include <dir1:dir2:...>', 'add directories into the search list', list)
  .option('-s, --sym <file>', 'create sym file')
  .parse(process.argv);

if(!program.args[0]) {
  console.error('Mising input file');
  program.help();
}

var z80 = new Z80();
if(program.include) {
  z80.searchPath = z80.searchPath.concat(program.include);
}
try {
  _.each(program.args, function(arg) {
    z80.compileFile(arg);
  });
  z80.secondPass();
  z80.saveImage(program.output || 'a.out');
  if(program.sym) {
    z80.saveSymbols(program.sym);
  }
} catch(e) {
  console.log('%s:%s: %s', e.filename, e.line, e.toString());
}
