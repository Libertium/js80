#!/usr/bin/env node
'use strict';

var JS80 = require('js80')
  , program = require('commander')
  , _ = require('underscore');

function list(val) {
    return val.split(':');
}

function printError(err) {
    if(err.macro) {
        console.log(
            '%s:%s: %s while executing macro %s',
            err.fileName,
            err.lineIndex,
            err.msg,
            err.macro);
    } else {
        console.log('%s:%s: %s', err.fileName, err.lineIndex, err.msg);
    }
}

// parse args
program
  .version('0.0.1')
  .usage('[options] <file ...>')
  .option('-o, --output <file>', 'create binary compiled file (default a.out)')
  .option('-I, --include <dir1:dir2:...>', 'add directories into the search list', list)
  .option('-s, --sym <file>', 'create sym file')
  .parse(process.argv);

if(!program.args[0]) {
    console.error('Missing input file');
    program.help();
}

// compile
var js80 = new JS80();
if(program.include) {
    js80.searchPath = js80.searchPath.concat(program.include);
}
_.each(program.args, function(arg) {
    js80.compileFile(arg);
});
js80.secondPass();
if(!_.isEmpty(js80.errors)) {
    _.each(js80.errors, printError);
    process.exit(1);
}

// output
js80.saveImage(program.output || 'a.out');
if(program.sym) {
    js80.saveSymbols(program.sym);
}

process.exit(0);
